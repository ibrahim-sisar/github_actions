name: Pull Request Notification to Discord

on:
  pull_request:
    types: [opened, synchronize, reopened]  # Runs when a PR is created, updated, or reopened

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Get Changed Files from GitHub API
        id: changed-files
        run: |
          FILES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
            | jq -r '.[].filename' | tr '\n' ' ')
          echo "FILES=$FILES" >> $GITHUB_ENV

      - name: Format PR Timestamp
        id: format-time
        run: |
          FORMATTED_TIME=$(date -u "+%A, %B %d, %Y at %I:%M %p UTC")
          echo "FORMATTED_TIME=$FORMATTED_TIME" >> $GITHUB_ENV

      - name: Send Notification to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Format file list for better readability
          FILES_FORMATTED=$(echo "${{ env.FILES }}" | tr ' ' '\n')

          # Construct the Discord message
          MESSAGE="üì¢ **Pull Request Update!**\nüë§ **User:** ${{ github.actor }}\nüîó **PR Title:** ${{ github.event.pull_request.title }}\nüìù **PR Description:**\n${{ github.event.pull_request.body }}\nüìÇ **Modified files:**\n\`\`\`${FILES_FORMATTED}\`\`\`\n‚è∞ **Time:** ${{ env.FORMATTED_TIME }}"

          # Convert message to JSON and send to Discord
          PAYLOAD=$(jq -n --arg msg "$MESSAGE" '{username: "GitHub Actions", content: $msg}')
          curl -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK_URL"
